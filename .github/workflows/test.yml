name: Deploy test server and run tests

on:
  push:

jobs:
  k8s-test:
    runs-on: ubuntu-22.04
    steps:
      - uses: azure/setup-helm@v4.2.0
        id: helm
        with:
           version: 'latest'

      - uses: debianmaster/actions-k3s@master
        id: k3s
        with:
          version: 'latest'

      - uses: actions/checkout@v4.2.1

      - name: Create k8s namespaces
        run: |
          kubectl create namespace explorer
          kubectl create namespace ctclip

      - name: Create storage class
        run: |
          cat>storageclass.yaml << EOF
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: weaviate
          provisioner: rancher.io/local-path
          reclaimPolicy: Delete
          volumeBindingMode: WaitForFirstConsumer
          EOF
          kubectl apply -f storageclass.yaml 
          rm storageclass.yaml
          
      - name: Set up secrets
        run: |
          kubectl -n explorer create secret generic ai-keys \
          --from-literal=google='your key' \
          --from-literal=azure='your key' \
          --from-literal=azure-resource='resource' \
          --from-literal=azure-assistant='assistant id' \
          --from-literal=azure-assistant-mini='assistant id'

      - name: Deploy CTCLIP
        run: |
          cd helm/ctclip
          #helm upgrade --install -n ctclip ctclip . \
          #--set huggingface.token=TODO \
          #--set resources.requests.memory=24000Mi \
          #--set resources.requests.cpu=2
          cd -

      - name: Deploy explorer
        run: |
          cd helm/explorer
          helm repo add weaviate https://weaviate.github.io/weaviate-helm
          helm dependency build
          helm upgrade --install -n explorer explorer . \
          --set resources.requests.memory=1000Mi \
          --set resources.requests.cpu=1
          cd -

      - name: kubectl describe nodes
        run: kubectl describe nodes

      - name: kubectl get nodes
        run: kubectl get nodes

      - name: kubectl -n explorer get events
        run: kubectl -n explorer get events

      - name: kubectl -n explorer get all
        run: kubectl -n explorer get all

      - name: Wait for weaviate startup
        run: |
          kubectl -n explorer wait --for=condition=Ready --timeout=60s pod/weaviate-0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
            python-version: '3.12'

      - name: Seed weaviate db
        run: |
          cd tests
          pip install -r requirements.txt
          python seed.py

      - name: Wait for app startup
        run: |
          kubectl -n explorer wait --for=condition=available --timeout=60s deployment/explorer
          kubectl wait --for=jsonpath='{.status.loadBalancer.ingress}' service/explorer -n explorer
          
      - name: kubectl -n explorer logs service/explorer
        run: kubectl -n explorer logs service/explorer

      - name: kubectl -n explorer get all
        run: kubectl -n explorer get all

      - name: Hit the app
        run: curl -s -o /dev/null -w "%{http_code}" http://localhost --fail-with-body

      - name: kubectl -n explorer logs service/explorer
        run: kubectl -n explorer logs service/explorer
