/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import {
  buildQueryContext,
  QueryFormData,
  AdhocColumn,
  ensureIsArray,
  PhysicalColumn,
  AdhocMetric,
} from '@superset-ui/core';
import axios from 'axios';

/**
 * The buildQuery function is used to create an instance of QueryContext that's
 * sent to the chart data endpoint. In addition to containing information of which
 * datasource to use, it specifies the type (e.g. full payload, samples, query) and
 * format (e.g. CSV or JSON) of the result and whether or not to force refresh the data from
 * the datasource as opposed to using a cached copy of the data, if available.
 *
 * More importantly though, QueryContext contains a property `queries`, which is an array of
 * QueryObjects specifying individual data requests to be made. A QueryObject specifies which
 * columns, metrics and filters, among others, to use during the query. Usually it will be enough
 * to specify just one query based on the baseQueryObject, but for some more advanced use cases
 * it is possible to define post processing operations in the QueryObject, or multiple queries
 * if a viz needs multiple different result sets.
 */

export default function buildQuery(formData: QueryFormData) {
  // TODO we'd need to pass the user-input text query to the backend and encode from there
  const embedding = [
    -0.03572528064250946, 0.00256526586599648, 0.017009608447551727, 0.012840312905609608,
    0.029643630608916283, -0.0367596410214901, 0.025208204984664917, -0.057000771164894104,
    0.005067043472081423, -0.0664803683757782, 0.016188962385058403, 0.04368903860449791,
    0.08902048319578171, -0.09057003259658813, 0.07760467380285263, 0.059559524059295654,
    0.02819565124809742, -0.015797562897205353, -0.0018103865440934896, 0.04734674468636513,
    -0.011834284290671349, 0.09242352843284607, 0.06703227758407593, -0.010097202844917774,
    0.07927005738019943, 0.006216193083673716, 0.019837163388729095, -0.004517323803156614,
    -0.059867121279239655, -0.10557325184345245, 0.011021317914128304, -0.0406610369682312,
    0.008381512947380543, 0.09000878781080246, 0.08861543983221054, 0.02788008376955986,
    0.0580628477036953, 0.0005993644008412957, 0.020794713869690895, 0.019612343981862068,
    -0.05980459600687027, -0.0056699113920331, 0.052854273468256, -0.02338503673672676,
    -0.007307008840143681, 0.08538009971380234, -0.021999038755893707, -0.012030096724629402,
    -0.07127664238214493, 0.017353110015392303, 0.011171563528478146, -0.04010334238409996,
    0.027169331908226013, 0.009876521304249763, -0.012266391888260841, -0.000799092638771981,
    -0.005601975601166487, 0.05670025572180748, -0.07364755868911743, 0.0289765652269125,
    -0.005311309825628996, -0.0214515570551157, 0.06770414113998413, -0.07580120861530304,
    0.09958573430776596, 0.03808249533176422, 0.05455729365348816, 0.031942546367645264,
    0.008940955623984337, 0.02983986772596836, 0.016739938408136368, -0.11579670011997223,
    0.05926663056015968, -0.017737552523612976, -0.012883394956588745, 0.0425153449177742,
    -0.034473564475774765, 0.04006955400109291, 0.023509152233600616, -0.012520494870841503,
    -0.08526445180177689, -0.0923616960644722, -0.06559820473194122, 0.020699234679341316,
    0.006451246328651905, -0.019347552210092545, 0.005130142904818058, 0.024003930389881134,
    -0.08040880411863327, 0.05645434930920601, -0.019856620579957962, -0.009732640348374844,
    -0.04190967231988907, 0.032968226820230484, -0.07996620237827301, 0.0283291507512331,
    -0.008725127205252647, 0.0029070982709527016, -0.0031565665267407894, 0.02803575061261654,
    0.07271143794059753, -0.006070139352232218, 0.010353640653192997, 0.03873632475733757,
    0.018624557182192802, 0.0008023169357329607, 0.0503968745470047, 0.019109519198536873,
    0.011567453853785992, 0.1029018834233284, -0.023593680933117867, -0.020913971588015556,
    -0.002907621208578348, 0.01092276256531477, 0.03518597409129143, -0.06806041300296783,
    0.07038699835538864, -0.020224614068865776, -0.061278823763132095, -0.11927034705877304,
    -0.06687277555465698, -0.0046298811212182045, -0.010480096563696861, -0.02718988247215748,
    0.03626387193799019, 0.07058081030845642, 0.0162686537951231, 0.049299340695142746,
    -0.07081937044858932, -0.04074051231145859, -0.04002552852034569, 0.03442419692873955,
    0.03893990069627762, 0.051320455968379974, -0.019677620381116867, 0.08078876882791519,
    -0.006982197519391775, -0.07050482928752899, -0.02049831673502922, 0.04172734171152115,
    0.053085003048181534, -0.018250741064548492, -0.041276272386312485, -0.03920973837375641,
    -0.00467290636152029, -0.03669706732034683, 0.005753168370574713, 0.046455465257167816,
    0.007330333814024925, 0.012195964343845844, 0.04085724428296089, -0.05685211345553398,
    -0.028750482946634293, -0.0013587187277153134, 0.038736384361982346, 0.12554395198822021,
    0.056637417525053024, -0.031868163496255875, -0.013413947075605392, 0.025489233434200287,
    -0.0037820928264409304, 0.003345942124724388, 0.0481538251042366, 0.1053251102566719,
    -0.05563066899776459, -0.04324507340788841, 0.026117198169231415, 0.018651414662599564,
    -0.07167670130729675, 0.02328888699412346, -0.032972101122140884, 0.05234149843454361,
    -0.007984613999724388, -0.030089985579252243, 0.0528838150203228, 0.005241100210696459,
    -0.009476106613874435, 0.01590568572282791, 0.02858644351363182, 0.016178743913769722,
    -0.08168268948793411, -0.013120556250214577, -0.028011420741677284, -0.03346818685531616,
    0.005999410524964333, -0.022200660780072212, 0.006123685277998447, 0.0630212053656578,
    -0.020144635811448097, 0.017730403691530228, -0.05046077072620392, 0.05446285754442215,
    0.028499392792582512, -0.016377296298742294, 0.005394279956817627, -0.013590442948043346,
    0.042680662125349045, -0.03394921123981476, 0.04941820725798607, 0.05959261953830719,
    -0.002333980519324541, -0.008061354048550129, 0.017948249354958534, 0.11281919479370117,
    -0.04277128726243973, -0.05729139596223831, 0.011575644835829735, -0.04849861189723015,
    0.07309471070766449, 0.08568345010280609, 0.003745470428839326, 0.04704514145851135,
    -0.003182708751410246, -0.004071454051882029, 0.003828994231298566, -0.044274620711803436,
    -0.010253584012389183, -0.007719684857875109, -0.05690515786409378, 0.03493792191147804,
    -0.051268793642520905, 0.08761020004749298, 0.028376363217830658, 0.07441405206918716,
    -0.0030717256013303995, 0.06590242683887482, 0.004579081665724516, -0.014018349349498749,
    0.08225315064191818, 0.017369475215673447, -0.04128322750329971, 0.0339929461479187,
    -0.011257465928792953, -0.001788971247151494, 0.0059217289090156555, -0.08630884438753128,
    0.012945336289703846, 0.029806140810251236, 0.04306731000542641, 0.06372296810150146,
    0.07670727372169495, 0.06064330413937569, 0.0023211603984236717, -0.04643150046467781,
    -0.0944535881280899, -0.025693727657198906, -0.04459480941295624, 0.030861107632517815,
    0.044524308294057846, -0.041525840759277344, 0.060508158057928085, 0.0016129935393109918,
    0.05393166467547417, 0.009539665654301643, 0.024221714586019516, 0.0006429909844882786,
    -0.003075647633522749, -0.04615704342722893, 0.04237528145313263, -0.080391526222229,
    0.04003584384918213, 0.040351737290620804, 0.04582696035504341, 0.04188081994652748,
    -0.03315013647079468, 0.01455681398510933, -0.047926176339387894, 0.06467565149068832,
    0.012443510815501213, 0.07970171421766281, 0.012672667391598225, 0.0672394186258316,
    -0.011164448224008083, -0.0007251815986819565, -0.07467898726463318, 0.023324638605117798,
    -0.0318952314555645, 0.00020221465092618018, -0.022823257371783257, 0.05468590930104256,
    -0.023339448496699333, 0.041585128754377365, -0.0009365301812067628, -0.022490138188004494,
    0.01286701112985611, 0.020787391811609268, -0.06710854917764664, -0.027822745963931084,
    0.010643997229635715, -0.09889855235815048, 0.013303874060511589, -0.022699275985360146,
    0.010239165276288986, -0.02195829525589943, 0.004105378873646259, 0.05573888495564461,
    0.08305788040161133, -0.005318062379956245, 0.0014151405775919557, 0.004555625841021538,
    0.014283099211752415, -0.0584566593170166, -0.007815700024366379, 0.030657397583127022,
    0.0470065139234066, -0.0432247519493103, -0.03270953148603439, -0.06245921179652214,
    0.03941936790943146, 0.06650420278310776, 0.029845502227544785, -0.0006360586849041283,
    0.09016652405261993, -0.01773807220160961, 0.07813318818807602, -0.02724124677479267,
    -0.07593978196382523, -0.008532713167369366, 0.029275141656398773, -0.04900000989437103,
    0.05811573192477226, -0.04968021810054779, -0.017628511413931847, 0.017376335337758064,
    -0.046402718871831894, -0.00337424548342824, -0.07072895765304565, 0.036233022809028625,
    0.06534935534000397, 0.07351460307836533, 0.00040794836240820587, -0.039429672062397,
    0.07780566066503525, 0.015532288700342178, -0.059878237545490265, -0.012492723762989044,
    -0.04305894300341606, -0.0020638254936784506, -0.08816880732774734, -0.04568469896912575,
    -0.021115144714713097, 0.10960801690816879, 0.02456348016858101, 0.05317600071430206,
    0.011391702108085155, 0.03768076002597809, -0.08906137943267822, 0.02894757129251957,
    0.06322624534368515, 0.0039850883185863495, 0.002976734656840563, -0.018817340955138206,
    0.08139931410551071, -0.04625977575778961, 0.005935255438089371, -0.007545888889580965,
    -0.026485031470656395, 0.0033704624511301517, 0.06426326185464859, -0.029975650832057,
    0.0968051329255104, 0.07609950006008148, -0.020064806565642357, -0.05718506872653961,
    0.018518097698688507, 0.006476274691522121, -0.04276742413640022, -0.03712359815835953,
    0.0004934652242809534, -0.036743756383657455, -0.07143095880746841, 0.001560154720209539,
    -0.042256176471710205, 0.030360147356987, -0.007575351744890213, -0.03266611322760582,
    0.01172593142837286, -0.04975691810250282, -0.012820702977478504, 0.021692868322134018,
    0.005328079219907522, 0.01159424427896738, 0.02903110347688198, 0.0023657935671508312,
    -0.03671189025044441, -0.029099149629473686, 0.07014548033475876, -0.05137280374765396,
    -0.011732515878975391, -0.001919275033287704, 0.02875678427517414, -0.045373328030109406,
    -0.0026872812304645777, 0.012457733042538166, 0.03251466527581215, 0.014102479442954063,
    0.01740504801273346, 0.009916074573993683, 0.018052618950605392, 0.049314871430397034,
    -0.060802362859249115, 0.013005506247282028, 0.015078768134117126, -0.015201984904706478,
    0.057136379182338715, 0.052628785371780396, 0.008236482739448547, -0.026451366022229195,
    0.018122240900993347, 0.04302322119474411, -0.022465746849775314, 0.04863784462213516,
    0.03565521165728569, 0.004156860522925854, 0.014955847524106503, 0.059200987219810486,
    0.011888260953128338, -0.00039330858271569014, -0.017853178083896637, 0.06154379993677139,
    0.06833351403474808, -0.017714589834213257, -0.0795622169971466, 0.012242879718542099,
    0.021343735978007317, 0.049675650894641876, -0.02671870030462742, -0.06032156944274902,
    0.004194557201117277, -0.03268292918801308, -0.019496653228998184, -0.017342178151011467,
    0.03223974257707596, 0.0352148562669754, -0.02293790876865387, -0.02509545534849167,
    -0.0989789068698883, -0.017591875046491623, -0.005344849545508623, -0.0179282296448946,
    0.0006919841398485005, 0.04291795939207077, 0.019874058663845062, -0.030275816097855568,
    0.032671473920345306, -0.01640692539513111, 0.0344710536301136, -0.002757177921012044,
    -0.007300942670553923, -0.05442764610052109, -0.011933709494769573, -0.0024967098142951727,
    0.004449178464710712, 0.07160481065511703, 0.05152488499879837, -0.09208894520998001,
    0.03493756055831909, -0.057702869176864624, 0.03438025340437889, 0.061732713133096695,
    -0.010019296780228615, 0.06034981459379196, -0.04784808307886124, 0.008249775506556034,
    0.0251304991543293, -0.05291183292865753, -0.034321967512369156, -0.06265528500080109,
    -0.001620778115466237, 0.008218321949243546, 0.027520544826984406, 0.014006777666509151,
    -0.02016797848045826, -0.017305850982666016, -0.020544597879052162, -0.03913542255759239,
    -0.03353326395153999, -0.057861633598804474, -0.009426561184227467, -0.008586734533309937,
    -0.013868848793208599, -0.027344314381480217, 0.015990713611245155, -0.03623490780591965,
    -0.11515451222658157, -0.017286311835050583, 0.02595994807779789, 0.0320231169462204,
    0.05163339152932167, -0.05066520348191261, -0.0014416698832064867, -0.03818655386567116,
    0.04840319976210594, 0.037911225110292435, -0.024446886032819748, 0.0019005379872396588,
    -0.005627790000289679, -0.026019195094704628, -0.07444576174020767, 0.028378115966916084,
    0.028504498302936554, -0.08285652846097946, -0.018027672544121742, -0.04752001538872719,
    -0.00581779470667243, -0.04140720143914223, -0.044099029153585434, 0.007938220165669918,
    0.03513466939330101, -0.11167008429765701, 0.06083577871322632, -0.0289299376308918,
  ];
  return buildQueryContext(formData, (baseQueryObject) => [
    {
      ...baseQueryObject,
      columns: [],
      metrics: [
        ...ensureIsArray(formData.columns).map((col) => {
          return {
            label: 'distance',
            sqlExpression: `cosineDistance(${col}, [${embedding}])`,
            expressionType: 'SQL',
          } as AdhocMetric;
        }),
      ],
      filters: [
        {
          col: 'distance',
          op: '<',
          val: formData.maxDistance,
        },
      ],
      orderby: [['distance', true]],
    },
  ]);
}
